name: Publish wheels to custom index

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v0.1.15-rocm or v0.1.15-cuda)'
        required: true
      platform:
        description: 'Platform to publish (rocm, cuda, or both)'
        required: true
        default: 'rocm'
        type: choice
        options:
          - rocm
          - cuda
          - both
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-to-github-pages:
    name: Publish to GitHub Pages index
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fastsafetensors-rocm repo
        uses: actions/checkout@v4
        with:
          path: fastsafetensors-rocm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install dumb-pypi

          # Install GitHub CLI
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Determine platform and version
        id: determine
        run: |
          # Determine version
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Determine platform from version tag or input
          if [ "${{ github.event_name }}" = "release" ]; then
            if [[ "${VERSION}" == *"rocm"* ]]; then
              PLATFORM="rocm"
            elif [[ "${VERSION}" == *"cuda"* ]]; then
              PLATFORM="cuda"
            else
              PLATFORM="both"
            fi
          else
            PLATFORM="${{ github.event.inputs.platform }}"
          fi
          echo "platform=${PLATFORM}" >> $GITHUB_OUTPUT

          echo "Publishing version: ${VERSION}"
          echo "Platform: ${PLATFORM}"

      - name: Download wheels from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.determine.outputs.version }}"
          PLATFORM="${{ steps.determine.outputs.platform }}"

          # Function to construct platform-specific version tag
          get_version_tag() {
            local platform=$1
            local version="${VERSION}"

            # If version already has platform suffix, use as-is
            if [[ "${version}" == *"-${platform}"* ]]; then
              echo "${version}"
            else
              # Otherwise append platform suffix
              echo "${version}-${platform}"
            fi
          }

          # Download ROCm wheels
          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            ROCM_VERSION=$(get_version_tag "rocm")
            mkdir -p wheels/rocm
            echo "Downloading ROCm wheels from release ${ROCM_VERSION}"
            cd wheels/rocm
            if ! gh release download "${ROCM_VERSION}" \
              --repo EmbeddedLLM/fastsafetensors-rocm \
              --pattern "*.whl"; then
              echo "ERROR: Failed to download ROCm wheels from ${ROCM_VERSION}"
              exit 1
            fi
            echo "Downloaded wheels:"
            ls -lah
            cd ../..
          fi

          # Download CUDA wheels
          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            CUDA_VERSION=$(get_version_tag "cuda")
            mkdir -p wheels/cuda
            echo "Downloading CUDA wheels from release ${CUDA_VERSION}"
            cd wheels/cuda
            if ! gh release download "${CUDA_VERSION}" \
              --repo EmbeddedLLM/fastsafetensors-rocm \
              --pattern "*.whl"; then
              echo "ERROR: Failed to download CUDA wheels from ${CUDA_VERSION}"
              exit 1
            fi
            echo "Downloaded wheels:"
            ls -lah
            cd ../..
          fi

      - name: Extract dependencies from pyproject.toml
        run: |
          PLATFORM="${{ steps.determine.outputs.platform }}"
          VERSION="${{ steps.determine.outputs.version }}"

          # Get absolute paths
          WORKSPACE_DIR="$(pwd)"
          REPO_DIR="${WORKSPACE_DIR}/fastsafetensors-rocm"

          # Copy script to temp location so it survives git checkout
          TEMP_SCRIPT="/tmp/extract_wheel_deps_$$.py"
          cp "${REPO_DIR}/.github/scripts/extract_wheel_deps.py" "${TEMP_SCRIPT}"

          echo "Workspace: ${WORKSPACE_DIR}"
          echo "Temp script: ${TEMP_SCRIPT}"
          echo "Repo: ${REPO_DIR}"

          # Determine version tag for ROCm/CUDA
          get_version_tag() {
            local platform=$1
            local version="${VERSION}"
            if [[ "${version}" == *"-${platform}"* ]]; then
              echo "${version}"
            else
              echo "${version}-${platform}"
            fi
          }

          extract_deps_for_platform() {
            local platform=$1
            local version_tag=$(get_version_tag "${platform}")
            local output_file="${WORKSPACE_DIR}/wheels/${platform}/requirements.txt"

            echo "Extracting dependencies for ${platform} from version ${version_tag}..."

            # Checkout the specific version tag to get its pyproject.toml
            cd "${REPO_DIR}"
            git fetch --tags

            # Save current commit
            local current_ref=$(git rev-parse HEAD)

            if ! git checkout "${version_tag}" 2>/dev/null; then
              echo "Warning: Could not checkout tag ${version_tag}, using current version"
            fi

            # Check if pyproject.toml exists
            if [ ! -f "pyproject.toml" ]; then
              echo "Error: pyproject.toml not found for version ${version_tag}"
              git checkout "${current_ref}"
              cd "${WORKSPACE_DIR}"
              return 1
            fi

            # Extract dependencies from pyproject.toml using script from temp location
            python3 "${TEMP_SCRIPT}" "pyproject.toml" "${output_file}"

            # Return to original commit
            git checkout "${current_ref}"
            cd "${WORKSPACE_DIR}"

            echo "Extracted dependencies:"
            cat "${output_file}"
          }

          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            extract_deps_for_platform "rocm"
          fi

          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            extract_deps_for_platform "cuda"
          fi

          # Cleanup temp script
          rm -f "${TEMP_SCRIPT}"

      - name: Download all dependencies
        run: |
          PLATFORM="${{ steps.determine.outputs.platform }}"

          # Function to download dependencies for a platform
          download_deps() {
            local platform=$1
            local dest_dir="wheels/${platform}"
            local req_file="${dest_dir}/requirements.txt"

            echo "Downloading dependencies for ${platform}..."

            if [ ! -f "${req_file}" ]; then
              echo "No requirements file found for ${platform}, skipping"
              return
            fi

            # For each Python version, download dependencies
            for py_ver in 3.9 3.10 3.11 3.12 3.13; do
              echo "Downloading dependencies for Python ${py_ver}"

              # Download dependencies using extracted requirements
              python -m pip download \
                --dest "${dest_dir}" \
                --only-binary :all: \
                --python-version ${py_ver} \
                --platform manylinux2014_x86_64 \
                --platform manylinux_2_17_x86_64 \
                --platform manylinux_2_27_x86_64 \
                --platform manylinux_2_28_x86_64 \
                -r "${req_file}" 2>/dev/null || echo "Some downloads failed for Python ${py_ver}"
            done

            # Also download using current Python for any missing wheels
            python -m pip download \
              --dest "${dest_dir}" \
              --only-binary :all: \
              -r "${req_file}" || true

            # Summary
            if [ -d "${dest_dir}" ] && [ "$(ls -A ${dest_dir}/*.whl 2>/dev/null)" ]; then
              echo "Total wheels collected for ${platform}:"
              ls -1 "${dest_dir}"/*.whl | wc -l

              echo "Wheel breakdown by package:"
              ls -1 "${dest_dir}"/*.whl | xargs -n1 basename | sed 's/-[0-9].*//' | sort | uniq -c
            fi
          }

          # Download for requested platforms
          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            download_deps "rocm"
          fi

          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            download_deps "cuda"
          fi

      - name: Checkout GitHub Pages repository
        uses: actions/checkout@v4
        with:
          repository: EmbeddedLLM/fastsafetensors-rocm
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          path: gh-pages-repo

      - name: Copy wheels and generate index
        run: |
          cd gh-pages-repo
          PLATFORM="${{ steps.determine.outputs.platform }}"
          VERSION="${{ steps.determine.outputs.version }}"

          # Function to generate index for a platform
          generate_index() {
            local platform=$1
            local version="${VERSION}"

            echo "Generating index for ${platform}..."

            # Clean up old index files to avoid conflicts
            rm -rf "${platform}/simple"
            rm -f "${platform}/package-list.txt"
            rm -f "${platform}/index.html"
            rm -f "${platform}/packages.json"

            # Create directory structure
            mkdir -p "${platform}/packages"
            mkdir -p "${platform}/manifests"

            # Copy all wheels
            if [ -d "../wheels/${platform}" ] && [ "$(ls -A ../wheels/${platform}/*.whl 2>/dev/null)" ]; then
              # Extract version number (remove 'v' prefix if present)
              local clean_version="${version#v}"

              # Remove OLD wheels for the SAME version only
              echo "Removing old fastsafetensors-${clean_version} wheels..."
              rm -f "${platform}/packages/fastsafetensors-${clean_version}"-*.whl || true

              # Copy new wheels
              echo "Copying new wheels..."
              cp ../wheels/${platform}/*.whl "${platform}/packages/"

              # Generate package list with just filenames (dumb-pypi doesn't accept paths with /)
              (cd "${platform}/packages" && ls *.whl) > "${platform}/package-list.txt"

              echo "Package list contents:"
              cat "${platform}/package-list.txt"

              # Create manifest for this version
              echo "Creating manifest for version ${clean_version}..."
              local manifest_file="${platform}/manifests/v${clean_version}.json"

              # Read dependencies from requirements.txt
              local deps_json="[]"
              if [ -f "../wheels/${platform}/requirements.txt" ]; then
                deps_json=$(python3 -c 'import json,sys; print(json.dumps([line.strip() for line in open("../wheels/'${platform}'/requirements.txt") if line.strip() and not line.startswith("#")]))')
              fi

              # List fastsafetensors wheels
              local fst_wheels_json=$(cd "${platform}/packages" && python3 -c 'import json,glob; print(json.dumps(sorted(glob.glob("fastsafetensors-'${clean_version}'-*.whl"))))')

              # List all downloaded wheels
              local all_wheels_json=$(cd "${platform}/packages" && python3 -c 'import json,glob; print(json.dumps(sorted(glob.glob("*.whl"))))')

              # Create manifest JSON using Python
              python3 -c "import json,sys; manifest={'fastsafetensors_version':'${clean_version}','published_at':'$(date -u +%Y-%m-%dT%H:%M:%SZ)','platform':'${platform}','dependencies':${deps_json},'fastsafetensors_wheels':${fst_wheels_json},'total_wheels_in_index':len(${all_wheels_json})}; json.dump(manifest,open('${manifest_file}','w'),indent=2)"

              echo "Created manifest:"
              cat "${manifest_file}"

              # Generate PEP 503 compliant index
              # Note: dumb-pypi expects wheel files to be accessible from where it runs
              # Run from packages/ directory so dumb-pypi can find the wheels by filename
              # packages-url is relative from simple/fastsafetensors/ to packages/: ../../packages
              (cd "${platform}/packages" && \
                dumb-pypi \
                  --package-list ../package-list.txt \
                  --packages-url ../../packages \
                  --output-dir .. \
                  --title "fastsafetensors ${platform^^} Index")

              echo "Generated ${platform} index for $(ls ${platform}/packages/*.whl | wc -l) wheels"

              # Debug: show generated structure
              echo "Generated structure:"
              ls -la "${platform}/simple/" || echo "No simple/ directory created"
              ls -la "${platform}/simple/fastsafetensors/" || echo "No fastsafetensors/ directory created"
            else
              echo "No wheels found for ${platform}, skipping index generation"
            fi
          }

          # Generate for requested platforms
          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            generate_index "rocm"
          fi

          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            generate_index "cuda"
          fi

      - name: Create index READMEs
        run: |
          cd gh-pages-repo
          PLATFORM="${{ steps.determine.outputs.platform }}"

          # Function to create README for a platform
          create_readme() {
            local platform=$1
            local platform_upper=$(echo $platform | tr '[:lower:]' '[:upper:]')

            if [ ! -d "${platform}/packages" ] || [ ! "$(ls -A ${platform}/packages/*.whl 2>/dev/null)" ]; then
              echo "No packages for ${platform}, skipping README"
              return
            fi

            cat > "${platform}/README.md" << EOF
          # fastsafetensors ${platform_upper} Package Index

          This is a custom Python package index for ${platform_upper}-built fastsafetensors wheels.

          ## Installation

          \`\`\`bash
          # Install fastsafetensors with ${platform_upper} support
          pip install fastsafetensors --index-url https://embeddedllm.github.io/fastsafetensors-rocm/${platform}/simple/
          \`\`\`

          ## Available Packages

          This index includes:
          - \`fastsafetensors\` - ${platform_upper} builds for Python 3.9-3.13
          - All dependencies (typer, click, etc.) for multiple Python versions and platforms

          ## What's Included

          EOF

            # List packages with counts
            echo "### Package Inventory" >> "${platform}/README.md"
            echo "" >> "${platform}/README.md"
            ls "${platform}/packages"/*.whl | sed 's/.*\///' | sed 's/-[0-9].*//' | sort | uniq -c | awk '{print "- " $2 ": " $1 " wheels"}' >> "${platform}/README.md"
          }

          # Create READMEs for requested platforms
          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            create_readme "rocm"
          fi

          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            create_readme "cuda"
          fi

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages-repo
          PLATFORM="${{ steps.determine.outputs.platform }}"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Add platform directories based on selection
          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            git add rocm/
          fi

          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            git add cuda/
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "$PLATFORM" = "both" ]; then
              git commit -m "Update ROCm and CUDA indices - $(date +%Y-%m-%d)"
            elif [ "$PLATFORM" = "cuda" ]; then
              git commit -m "Update CUDA index - $(date +%Y-%m-%d)"
            else
              git commit -m "Update ROCm index - $(date +%Y-%m-%d)"
            fi
            git push
            echo "Successfully pushed to gh-pages branch"
          fi

      - name: Summary
        run: |
          PLATFORM="${{ steps.determine.outputs.platform }}"

          echo "## Published to GitHub Pages! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PLATFORM" = "rocm" ] || [ "$PLATFORM" = "both" ]; then
            echo "### ROCm Index" >> $GITHUB_STEP_SUMMARY
            echo "Index URL: https://embeddedllm.github.io/fastsafetensors-rocm/rocm/simple/" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install fastsafetensors --index-url https://embeddedllm.github.io/fastsafetensors-rocm/rocm/simple/" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PLATFORM" = "cuda" ] || [ "$PLATFORM" = "both" ]; then
            echo "### CUDA Index" >> $GITHUB_STEP_SUMMARY
            echo "Index URL: https://embeddedllm.github.io/fastsafetensors-rocm/cuda/simple/" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "pip install fastsafetensors --index-url https://embeddedllm.github.io/fastsafetensors-rocm/cuda/simple/" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
